name: Monthly rootfs build

on:
  schedule:
    - cron: "0 2 1 * *" # Runs at 02:00 UTC on the 1st of every month
  workflow_dispatch: # Allows manual trigger

jobs:
  # ----------------------------------------------
  # Job 1: Build (Runs inside the Arch Container)
  # ----------------------------------------------
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    outputs:
      # Expose the calculated tag name and date to the next job
      new_tag: ${{ steps.tag_info.outputs.NEW_TAG }}
      release_date: ${{ steps.tag_info.outputs.RELEASE_DATE }}
    env:
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
    steps:
      # Checkout to the default /github/workspace inside the container
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps AND Git
        # This runs inside the Arch Linux container
        run: |
          pacman -Sy --noconfirm base base-devel arch-install-scripts squashfs-tools git

      - name: Setup GPG
        # This runs inside the Arch Linux container
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" > /tmp/gpg.key
          gpg --batch --import /tmp/gpg.key
          rm -f /tmp/gpg.key

      - name: Build rootfs
        # This runs inside the Arch Linux container
        env:
          GPG_KEY: ${{ secrets.GPG_KEY }}
        run: |
          chmod +x build.sh
          ./build.sh
          # rootfs.squashfs is now at /github/workspace/out/rootfs.squashfs

      - name: Calculate release date and tag name
        id: tag_info
        # Use the new $GITHUB_OUTPUT method
        run: |
          RELEASE_DATE=$(date +'%Y-%m-%d')
          NEW_TAG="monthly-release-${RELEASE_DATE}"
          echo "RELEASE_DATE=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Calculated tag: $NEW_TAG"

      - name: Upload rootfs artifact
        uses: actions/upload-artifact@v4
        with:
          name: rootfs # Name of the artifact
          path: out/rootfs.squashfs
          retention-days: 7 # Optional: keep for 7 days

  # ----------------------------------------------
  # Job 2: Release (Runs on the Host Runner)
  # ----------------------------------------------
  release:
    runs-on: ubuntu-latest # Runs on the host runner, outside the container
    needs: build # Waits for the 'build' job to complete
    steps:
      - name: Checkout code (for git tagging)
        # Need to checkout again on the host runner for git commands
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to push tags

      - name: Download rootfs artifact
        # The artifact is downloaded to the current working directory (e.g., /home/runner/work/repo/repo/out/)
        uses: actions/download-artifact@v4
        with:
          name: rootfs
          path: out/

      - name: Create and Push Git Tag
        # This step runs on the HOST runner, which has a stable git environment
        id: create_tag
        env:
          NEW_TAG: ${{ needs.build.outputs.new_tag }}
          RELEASE_DATE: ${{ needs.build.outputs.release_date }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Check if tag already exists before creating/pushing
          if git ls-remote --tags origin | grep "refs/tags/$NEW_TAG"; then
            echo "Tag $NEW_TAG already exists. Skipping tag creation."
            echo "tag_created=false" >> $GITHUB_OUTPUT
          else
            git tag -a "$NEW_TAG" -m "Monthly automated release for $RELEASE_DATE"
            # Use the GITHUB_TOKEN for pushing the tag
            git push origin "$NEW_TAG"
            echo "Tag $NEW_TAG created and pushed successfully."
            echo "tag_created=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release with Artifact
        # Only run if a new tag was successfully created
        if: steps.create_tag.outputs.tag_created == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: out/rootfs.squashfs # Path is relative to the host runner's workspace
          tag_name: ${{ needs.build.outputs.new_tag }} # Use the dynamically created tag name
          name: "Monthly Release ${{ needs.build.outputs.new_tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Required for release creation
